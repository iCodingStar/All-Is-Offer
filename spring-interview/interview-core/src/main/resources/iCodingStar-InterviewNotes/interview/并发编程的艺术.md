# 并发编程的艺术

## 并发编程的挑战

### 上下文切换
- CPU通过时间片算法循环执行任务，任务之间切换需要保存上一个任务状态，这就是上下文切换。

#### 多线程一定快吗？
- 由于上下文切换，因而多线程不一定比单线程效率高。

#### 测试上下文切换次数和时长
- 切换时长测试：Lmbench3
- 切换次数测试：vmstat(每秒1000多次)

#### 如何减少上下文切换
- 无锁并发编程：多线程竞争锁会引起上下文切换,在多线程处理数据时，可以将数据的ID通过取模Hash分组，不同的线程处理不同分组的数据。
- CAS算法：使用CAS算法更新数据，不需要加锁。
- 使用最小线程：避免创建过多的线程，根据数据量的大小调整。
- 协程：单线程里面实现多任务的调度，在单线程中维护多个任务的切换。

#### 减少上下文切换实战
* 通过减少大量的waiting线程来减少上下文切换次数。
  * jsatck命令dump线程信息 ： `jstack 4883 > /home/star/logs/java/dump.log`
  * 统计Java进程中线程的状态 ： `grep java.lang.Thread.State logs/java/dump.log|awk -F ":" '{print $2$3}'|sort|uniq -c`

### 死锁
